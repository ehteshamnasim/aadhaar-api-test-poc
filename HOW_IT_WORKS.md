# How Selective Test Regeneration Works

## Test Execution Numbers Explained

### What You See:
```
Test Execution:
- 9 Passed
- 18 Failed  
- 27 Total
```

### What It Means:
- **27 Total** = 21 preserved (old) + 6 regenerated (new)
- It **RUNS** all 27 tests
- It **GENERATED** only 6 new tests
- It **PRESERVED** 21 old tests

### Why It Shows This Way:
The "Test Execution" tab shows **runtime results** (how many tests passed/failed when run against your API), NOT how many were generated.

---

## Where Preserved Tests Come From

### Storage Location:
```
tests/
├── test_aadhaar_api.py        ← Version 1 (original)
├── test_aadhaar_api_v2.py     ← Version 2
├── test_aadhaar_api_v3.py     ← Version 3
├── ...                        
└── test_aadhaar_api_v50.py    ← Current version (your latest)
```

### How It Works:

1. **First Run** (No changes):
   - Generates ALL tests for ALL 9 endpoints
   - Saves to `test_aadhaar_api.py`

2. **Second Run** (You change 1 endpoint):
   - Loads previous version: `test_aadhaar_api.py`
   - Extracts tests for 8 unchanged endpoints (21 tests)
   - Generates tests for 1 changed endpoint (6 new tests)
   - **Merges** 21 old + 6 new = 27 total
   - Saves to `test_aadhaar_api_v2.py`

3. **Third Run** (You change 1 endpoint again):
   - Loads previous version: `test_aadhaar_api_v2.py`
   - Extracts tests for 8 unchanged endpoints
   - Generates tests for 1 changed endpoint
   - Merges and saves to `test_aadhaar_api_v3.py`

### Code Logic (main.py lines 533-610):

```python
def _load_previous_tests(self):
    """Load tests from most recent previous version"""
    prev_version = self.version - 1
    prev_filename = f'test_aadhaar_api_v{prev_version}.py'
    prev_path = os.path.join(self.output_dir, prev_filename)
    
    if os.path.exists(prev_path):
        with open(prev_path, 'r') as f:
            return f.read()  # Returns OLD test code
    return None

def _extract_tests_for_endpoints(self, test_code, endpoints_to_keep):
    """Extract test functions for specific unchanged endpoints"""
    # Uses regex to find test functions
    # Filters tests matching unchanged endpoint paths
    # Returns list of preserved test functions
    
def _merge_tests(self, old_tests, new_tests, parsed_spec):
    """Merge old passing tests with new generated tests"""
    # Gets all endpoint paths from spec
    # Identifies unchanged endpoints
    # Extracts tests for unchanged endpoints from old_tests
    # Combines: old tests + new tests = merged file
```

---

## Spec Tracking Files

### Current Structure:
```
/Users/ehtesham/Developer/aadhaar-api-test-poc/
├── specs/
│   └── aadhaar-api.yaml                    ← Your API spec
├── .spec_version_aadhaar-api               ← Baseline for change detection
├── tests/
│   ├── test_aadhaar_api.py                 ← Version 1
│   └── test_aadhaar_api_v*.py              ← Version 2, 3, 4...
```

### What `.spec_version_aadhaar-api` Does:
- Stores **previous** version of your spec
- Used to **detect changes** (compare current vs previous)
- **Auto-updates** after each run
- **NOT** the preserved tests (those are in `tests/` folder)

---

## Why Total = Preserved + Regenerated

### Example Flow:

**Your API has 9 endpoints:**
- `/aadhaar/verify-cache` (3 tests)
- `/aadhaar/verify-otp` (3 tests)
- `/aadhaar/generate-otp` (3 tests)
- `/aadhaar/ekyc` (3 tests)
- `/aadhaar/demographics` (2 tests)
- `/aadhaar/biometric` (3 tests)
- `/aadhaar/masked-aadhaar` (2 tests)
- `/aadhaar/face-authentication` (2 tests)
- `/aadhaar/health-check` (3 tests)

**You change ONLY `/aadhaar/verify-cache` (add 403 response):**

1. **Load Previous**: `test_aadhaar_api_v49.py` (had 27 tests)
2. **Extract Preserved**: 
   - Keep tests for 8 unchanged endpoints = 21 tests
3. **Generate New**:
   - Generate tests for 1 changed endpoint = 6 tests
4. **Merge & Save**:
   - 21 preserved + 6 new = 27 total
   - Save to `test_aadhaar_api_v50.py`

### Then Run Tests:
- **Execute** all 27 tests against your API
- **Results**: 9 passed, 18 failed (because API not running)
- **Total**: 27 (same as preserved + regenerated)

---

## Summary

| What | Number | Source |
|------|--------|--------|
| **Total Tests** | 27 | Merged file with all tests |
| **Preserved Tests** | 21 | Copied from `test_aadhaar_api_v49.py` |
| **Regenerated Tests** | 6 | Generated by AI for changed endpoint |
| **Passed Tests** | 9 | Runtime result (when tests run) |
| **Failed Tests** | 18 | Runtime result (API not available) |

**Key Insight**: The 27 total is BOTH preserved AND regenerated combined into ONE test file that gets executed!
